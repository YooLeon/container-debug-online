<!DOCTYPE html>
<html>
<head>
    <title>Docker Terminal</title>
    <link rel="stylesheet" href="https://unpkg.com/xterm/css/xterm.css" />
    <script src="https://unpkg.com/xterm/lib/xterm.js"></script>
    <script src="https://unpkg.com/xterm-addon-fit/lib/xterm-addon-fit.js"></script>
    <style>
        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100vh;
            overflow: hidden;
        }

        body {
            display: flex;
            flex-direction: column;
            background-color: #1e1e1e;
        }

        .tab-container {
            background-color: #2d2d2d;
            padding: 10px;
            display: flex;
            gap: 5px;
            border-bottom: 2px solid #1e1e1e;
        }

        .tab-button {
            padding: 8px 16px;
            border: none;
            background-color: #3d3d3d;
            color: #999;
            cursor: pointer;
            border-radius: 4px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            position: relative;
            border: 1px solid transparent;
        }

        .tab-button.active {
            background-color: #4caf50 !important;
            color: #fff !important;
            border: 1px solid #66bb6a !important;
            box-shadow: 0 2px 4px rgba(76, 175, 80, 0.2);
        }

        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }

        .tab-button.healthy .status-indicator {
            background-color: #4CAF50;
            box-shadow: 0 0 5px #4CAF50;
        }

        .tab-button.unhealthy .status-indicator {
            background-color: #f44336;
            box-shadow: 0 0 5px #f44336;
        }

        .health-status-container {
            margin-top: 8px;
            padding: 8px;
            border-top: 1px solid #ddd;
        }

        .tab-button {
            position: relative;
        }

        .tab-button .status-indicator {
            transition: background-color 0.3s ease;
        }

        .tab-button:hover .status-indicator::after {
            content: attr(title);
            position: absolute;
            top: -25px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            white-space: nowrap;
        }

        #terminal-container {
            flex: 1;
            position: relative;
            overflow: hidden;
            background-color: #1e1e1e;
            min-height: 0;
            display: flex;
        }

        .terminal-tab {
            display: none;
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            width: 100%;
            height: 100%;
        }

        .terminal-tab.active {
            display: flex;
            flex-direction: column;
        }

        .xterm {
            height: 100% !important;
            width: 100% !important;
        }

        .xterm-screen {
            width: 100% !important;
            height: 100% !important;
        }

        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
            transition: background-color 0.3s ease;
        }

        .status-indicator.connected {
            background-color: #4CAF50;
            box-shadow: 0 0 5px #4CAF50;
        }

        .status-indicator.disconnected {
            background-color: #f44336;
            box-shadow: 0 0 5px #f44336;
        }

        .terminal-tab {
            width: 100%;
            height: 100%;
            padding: 5px;
            box-sizing: border-box;
        }

        .terminal-tab .xterm {
            height: 100%;
            width: 100%;
        }

        .terminal-tab .xterm-viewport {
            width: 100% !important;
        }

        .terminal-tab .xterm-screen {
            width: 100% !important;
        }
    </style>
</head>
<body>
    <div class="tab-container" id="tab-container"></div>
    <div id="terminal-container"></div>

    <script>
        class TerminalManager {
            constructor() {
                this.terminals = new Map();
                this.activeTerminal = null;
                this.terminalContainer = document.getElementById('terminal-container');
                this.tabContainer = document.getElementById('tab-container');
                
                this.resizeObserver = new ResizeObserver(entries => {
                    for (const entry of entries) {
                        if (entry.target === this.terminalContainer) {
                            this.handleContainerResize();
                        }
                    }
                });
                
                this.resizeObserver.observe(this.terminalContainer);
                
                this.loadContainers().then(() => {
                    const firstContainer = this.terminals.keys().next().value;
                    if (firstContainer) {
                        this.activateTerminal(firstContainer);
                    }
                });

                this.healthStatus = new Map();
                this.createHealthStatusUI();
            }

            createHealthStatusUI() {
                const statusContainer = document.createElement('div');
                statusContainer.className = 'health-status-container';
                this.tabContainer.appendChild(statusContainer);
            }

            updateHealthStatus(containerId, status) {
                this.healthStatus.set(containerId, status);
                
                const button = document.querySelector(`.tab-button[data-container-id="${containerId}"]`);
                if (button) {
                    button.classList.remove('healthy', 'unhealthy');
                    button.classList.add(status.toLowerCase());
                    
                    const indicator = button.querySelector('.status-indicator');
                    if (indicator) {
                        indicator.title = `Health: ${status} (Last checked: ${new Date().toLocaleTimeString()})`;
                    }
                }
            }

            handleContainerResize() {
                const dimensions = this.calculateTerminalDimensions();
                for (const [_, terminal] of this.terminals) {
                    if (terminal.term) {
                        terminal.term.resize(dimensions.cols, dimensions.rows);
                        if (terminal.ws && terminal.ws.readyState === WebSocket.OPEN) {
                            terminal.ws.send(JSON.stringify({
                                type: 'resize',
                                cols: dimensions.cols,
                                rows: dimensions.rows
                            }));
                        }
                    }
                }
            }

            calculateTerminalDimensions() {
                const containerStyle = window.getComputedStyle(this.terminalContainer);
                const width = parseInt(containerStyle.width);
                const height = parseInt(containerStyle.height);
                
                const fontSize = 14; // px
                const charWidth = fontSize * 0.6; // 估算单个字符宽度
                const charHeight = fontSize * 1.2; // 估算行高

                const cols = Math.max(Math.floor((width - 20) / charWidth), 80); // 最小80列
                const rows = Math.max(Math.floor((height - 20) / charHeight), 24); // 最小24行

                return { cols, rows };
            }

            async loadContainers() {
                try {
                    const response = await fetch('/containers');
                    const containers = await response.json();
                    
                    for (const container of containers) {
                        await this.createTerminal(container);
                    }
                } catch (error) {
                    console.error('Failed to load containers:', error);
                }
            }

            async createTerminal(container) {
                const terminalDiv = document.createElement('div');
                terminalDiv.className = 'terminal-tab';
                terminalDiv.id = `terminal-${container.id}`;
                terminalDiv.style.display = 'none';
                this.terminalContainer.appendChild(terminalDiv);

                const dimensions = this.calculateTerminalDimensions();

                const term = new Terminal({
                    cursorBlink: true,
                    fontSize: 14,
                    fontFamily: 'Menlo, Monaco, "Courier New", monospace',
                    scrollback: 1000,
                    theme: {
                        background: '#1e1e1e',
                        foreground: '#d4d4d4'
                    },
                    allowTransparency: true,
                    cols: dimensions.cols,
                    rows: dimensions.rows,
                    windowsMode: true,
                    rendererType: 'canvas',
                });

                const fitAddon = new FitAddon.FitAddon();
                term.loadAddon(fitAddon);

                term.open(terminalDiv);
                
                terminalDiv.style.width = '100%';
                terminalDiv.style.height = '100%';
                terminalDiv.style.padding = '5px';
                
                fitAddon.fit();

                const ws = new WebSocket(`ws://${window.location.host}/ws?container=${container.id}`);
                
                ws.onopen = () => {
                    console.log(`WebSocket connected for ${container.id}`);
                    this.setConnectionStatus(container.id, true);
                    
                    ws.send(JSON.stringify({
                        type: 'resize',
                        cols: dimensions.cols,
                        rows: dimensions.rows
                    }));
                };

                ws.onmessage = (event) => {
                    term.write(event.data);
                };

                term.onData(data => {
                    if (ws.readyState === WebSocket.OPEN) {
                        ws.send(data);
                    }
                });

                ws.onclose = () => {
                    console.log(`WebSocket closed for ${container.id}`);
                    this.setConnectionStatus(container.id, false);
                    term.write('\r\n\x1b[31mConnection closed\x1b[0m\r\n');
                };

                ws.onerror = (error) => {
                    console.error(`WebSocket error for ${container.id}:`, error);
                    this.setConnectionStatus(container.id, false);
                };

                this.terminals.set(container.id, {
                    term,
                    ws,
                    div: terminalDiv,
                    fitAddon,
                    connected: false
                });

                const tabButton = document.createElement('button');
                tabButton.className = 'tab-button';
                tabButton.setAttribute('data-container-id', container.id);
                tabButton.innerHTML = `
                    <span class="status-indicator"></span>
                    <div class="container-info">
                        <span class="container-name">${container.name}</span>
                        <span class="container-id">${container.id}</span>
                    </div>
                `;
                
                tabButton.addEventListener('click', () => {
                    this.activateTerminal(container.id);
                });
                
                this.tabContainer.appendChild(tabButton);
            }

            activateTerminal(containerId) {
                const terminal = this.terminals.get(containerId);
                if (!terminal) return;

                this.terminals.forEach((t) => {
                    t.div.classList.remove('active');
                    t.div.style.display = 'none';
                });

                document.querySelectorAll('.tab-button').forEach(button => {
                    button.classList.remove('active');
                });

                terminal.div.classList.add('active');
                terminal.div.style.display = 'block';
                
                const button = document.querySelector(`.tab-button[data-container-id="${containerId}"]`);
                if (button) {
                    button.classList.add('active');
                }

                this.activeTerminal = terminal;
                terminal.term.focus();
                terminal.fitAddon.fit();

                if (terminal.ws && terminal.ws.readyState === WebSocket.OPEN) {
                    const dimensions = this.calculateTerminalDimensions();
                    terminal.ws.send(JSON.stringify({
                        type: 'resize',
                        cols: dimensions.cols,
                        rows: dimensions.rows
                    }));
                }
            }

            setConnectionStatus(containerId, isConnected) {
                const terminal = this.terminals.get(containerId);
                if (terminal) {
                    terminal.connected = isConnected;
                }

                const button = document.querySelector(`.tab-button[data-container-id="${containerId}"]`);
                if (button) {
                    const indicator = button.querySelector('.status-indicator');
                    if (indicator) {
                        indicator.classList.remove('connected', 'disconnected');
                        indicator.classList.add(isConnected ? 'connected' : 'disconnected');
                    }
                }
            }
        }

        const manager = new TerminalManager();
    </script>
</body>
</html> 