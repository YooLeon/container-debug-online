<!DOCTYPE html>
<html>
<head>
    <title>Docker Terminal</title>
    <link rel="stylesheet" href="https://unpkg.com/xterm/css/xterm.css" />
    <script src="https://unpkg.com/xterm/lib/xterm.js"></script>
    <script src="https://unpkg.com/xterm-addon-fit/lib/xterm-addon-fit.js"></script>
    <style>
        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100vh;
            overflow: hidden;
        }

        body {
            display: flex;
            flex-direction: column;
            background-color: #1e1e1e;
        }

        .tab-container {
            background-color: #2d2d2d;
            padding: 10px;
            display: flex;
            gap: 5px;
            border-bottom: 2px solid #1e1e1e;
        }

        .tab-button {
            padding: 8px 16px;
            border: none;
            background-color: #3d3d3d;
            color: #999;
            cursor: pointer;
            border-radius: 4px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            position: relative;
            border: 1px solid transparent;
        }

        .tab-button.active {
            background-color: #4caf50 !important;
            color: #fff !important;
            border: 1px solid #66bb6a !important;
            box-shadow: 0 2px 4px rgba(76, 175, 80, 0.2);
        }

        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #666;
        }

        .status-indicator.connected {
            background-color: #4CAF50;
            box-shadow: 0 0 4px rgba(76, 175, 80, 0.5);
        }

        .status-indicator.disconnected {
            background-color: #e74c3c;
        }

        #terminal-container {
            flex: 1;
            position: relative;
            overflow: hidden;
            background-color: #1e1e1e;
            min-height: 0;
            display: flex;
        }

        .terminal-tab {
            display: none;
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            width: 100%;
            height: 100%;
        }

        .terminal-tab.active {
            display: flex;
            flex-direction: column;
        }

        .xterm {
            height: 100% !important;
            width: 100% !important;
        }

        .xterm-screen {
            width: 100% !important;
            height: 100% !important;
        }
    </style>
</head>
<body>
    <div class="tab-container" id="tab-container"></div>
    <div id="terminal-container"></div>

    <script>
        class TerminalManager {
            constructor() {
                this.terminals = new Map();
                this.activeTerminal = null;
                this.terminalContainer = document.getElementById('terminal-container');
                this.tabContainer = document.getElementById('tab-container');
                
                this.resizeObserver = new ResizeObserver(entries => {
                    for (const entry of entries) {
                        if (entry.target === this.terminalContainer) {
                            this.handleContainerResize();
                        }
                    }
                });
                
                this.resizeObserver.observe(this.terminalContainer);
                
                this.loadContainers().then(() => {
                    const firstContainer = this.terminals.keys().next().value;
                    if (firstContainer) {
                        this.activateTerminal(firstContainer);
                    }
                });
            }

            handleContainerResize() {
                const dimensions = this.calculateTerminalDimensions();
                for (const [_, terminal] of this.terminals) {
                    if (terminal.term) {
                        terminal.term.resize(dimensions.cols, dimensions.rows);
                        if (terminal.ws && terminal.ws.readyState === WebSocket.OPEN) {
                            terminal.ws.send(JSON.stringify({
                                type: 'resize',
                                cols: dimensions.cols,
                                rows: dimensions.rows
                            }));
                        }
                    }
                }
            }

            calculateTerminalDimensions() {
                const containerStyle = window.getComputedStyle(this.terminalContainer);
                const containerWidth = parseInt(containerStyle.width, 10);
                const containerHeight = parseInt(containerStyle.height, 10);

                const tempTerm = document.createElement('div');
                tempTerm.style.visibility = 'hidden';
                tempTerm.style.position = 'absolute';
                tempTerm.style.fontFamily = 'Menlo, Monaco, "Courier New", monospace';
                tempTerm.style.fontSize = '14px';
                tempTerm.textContent = 'X';
                document.body.appendChild(tempTerm);

                const charWidth = tempTerm.offsetWidth;
                const charHeight = tempTerm.offsetHeight;
                document.body.removeChild(tempTerm);

                const cols = Math.floor((containerWidth - 20) / charWidth);
                const rows = Math.floor((containerHeight - 20) / charHeight);

                return { cols: Math.max(cols, 80), rows: Math.max(rows, 24) };
            }

            async loadContainers() {
                try {
                    const response = await fetch('/containers');
                    const containers = await response.json();
                    
                    for (const container of containers) {
                        await this.createTerminal(container);
                    }
                } catch (error) {
                    console.error('Failed to load containers:', error);
                }
            }

            async createTerminal(container) {
                const terminalDiv = document.createElement('div');
                terminalDiv.className = 'terminal-tab';
                terminalDiv.id = `terminal-${container.id}`;
                terminalDiv.style.display = 'none';
                this.terminalContainer.appendChild(terminalDiv);

                const dimensions = this.calculateTerminalDimensions();

                const term = new Terminal({
                    cursorBlink: true,
                    fontSize: 14,
                    fontFamily: 'Menlo, Monaco, "Courier New", monospace',
                    scrollback: 1000,
                    theme: {
                        background: '#1e1e1e',
                        foreground: '#d4d4d4'
                    },
                    allowTransparency: true,
                    cols: dimensions.cols,
                    rows: dimensions.rows
                });

                const fitAddon = new FitAddon.FitAddon();
                term.loadAddon(fitAddon);

                term.open(terminalDiv);
                fitAddon.fit();

                terminalDiv.style.width = '100%';
                terminalDiv.style.height = '100%';
                
                const ws = new WebSocket(`ws://${window.location.host}/ws?container=${container.id}`);
                
                ws.onopen = () => {
                    console.log(`WebSocket connected for ${container.id}`);
                    this.updateTabStatus(container.id, true);
                    
                    ws.send(JSON.stringify({
                        type: 'resize',
                        cols: dimensions.cols,
                        rows: dimensions.rows
                    }));
                };

                ws.onmessage = (event) => {
                    if (event.data) {
                        term.write(event.data);
                    }
                };

                term.onData((data) => {
                    if (ws.readyState === WebSocket.OPEN) {
                        try {
                            ws.send(data);
                        } catch (error) {
                            console.error('Error sending data:', error);
                        }
                    }
                });

                term.onResize((size) => {
                    if (ws.readyState === WebSocket.OPEN) {
                        try {
                            ws.send(JSON.stringify({
                                type: 'resize',
                                cols: size.cols,
                                rows: size.rows
                            }));
                        } catch (error) {
                            console.error('Error sending resize:', error);
                        }
                    }
                });

                ws.onclose = () => {
                    console.log(`WebSocket closed for ${container.id}`);
                    this.updateTabStatus(container.id, false);
                    term.write('\r\n\x1b[31mConnection closed\x1b[0m\r\n');
                };

                ws.onerror = (error) => {
                    console.error(`WebSocket error for ${container.id}:`, error);
                    this.updateTabStatus(container.id, false);
                };

                this.terminals.set(container.id, {
                    term,
                    ws,
                    div: terminalDiv,
                    fitAddon,
                    connected: true
                });

                const tabButton = document.createElement('button');
                tabButton.className = 'tab-button';
                tabButton.setAttribute('data-container-id', container.id);
                tabButton.innerHTML = `
                    <span class="status-indicator"></span>
                    <div class="container-info">
                        <span class="container-name">${container.name}</span>
                        <span class="container-id">${container.id}</span>
                    </div>
                `;
                
                tabButton.addEventListener('click', () => {
                    this.activateTerminal(container.id);
                });
                
                this.tabContainer.appendChild(tabButton);
            }

            activateTerminal(containerId) {
                const terminal = this.terminals.get(containerId);
                if (!terminal) return;

                this.terminals.forEach((t) => {
                    t.div.classList.remove('active');
                    t.div.style.display = 'none';
                });

                document.querySelectorAll('.tab-button').forEach(button => {
                    button.classList.remove('active');
                });

                terminal.div.classList.add('active');
                terminal.div.style.display = 'block';
                
                const button = document.querySelector(`.tab-button[data-container-id="${containerId}"]`);
                if (button) {
                    button.classList.add('active');
                }

                this.activeTerminal = terminal;
                terminal.term.focus();
                terminal.fitAddon.fit();

                if (terminal.ws && terminal.ws.readyState === WebSocket.OPEN) {
                    const dimensions = this.calculateTerminalDimensions();
                    terminal.ws.send(JSON.stringify({
                        type: 'resize',
                        cols: dimensions.cols,
                        rows: dimensions.rows
                    }));
                }
            }
        }

        const manager = new TerminalManager();
    </script>
</body>
</html> 